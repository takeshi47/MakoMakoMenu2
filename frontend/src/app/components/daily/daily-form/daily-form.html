<div class="container my-4">
  <div class="col-lg-8 offset-lg-2">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <h2 class="mb-4 text-center">献立登録</h2>
      @if (errorMessages) {
        <div class="alert alert-danger" role="alert">
          <p class="fw-bold mb-1">以下のエラーが発生しました:</p>
          <ul>
            @for (error of errorMessages | keyvalue; track error) {
              <li>{{ error.key }}: {{ error.value | json }}</li>
            }
          </ul>
        </div>
      }
      <!-- 日付入力フィールド -->
      <div class="mb-3">
        <label for="date" class="h5 form-label">日付:</label>
        <input id="date" type="date" formControlName="date" class="form-control" />
        @if (errorMessages?.['date']) {
          <ul>
            @for (error of errorMessages?.['date'] | keyvalue; track error) {
              <li>{{ error.value }}</li>
            }
          </ul>
        }
      </div>

      <!-- 食事(meals)のFormArrayを描画するセクション -->
      <div formArrayName="meals">
        <h3 class="h5">食事:</h3>

        <!-- 各食事を @for でループして描画 -->
        @for (meal of meals.controls; track meal; let i = $index) {
          <div [formGroupName]="i" class="border rounded p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="h6 mb-0">食事 {{ i + 1 }}</h4>
              <button
                type="button"
                (click)="removeMeal(i)"
                class="btn-close"
                aria-label="この食事を削除"
              ></button>
            </div>

            <!-- 食事タイプ (朝食/昼食/夕食) -->
            <div class="mb-3">
              <label [for]="'mealType' + i" class="form-label">タイプ:</label>
              <select [id]="'mealType' + i" formControlName="mealType" class="form-select">
                <option [value]="this.MEAL_TYPE_CHOICES[0]">朝食</option>
                <option [value]="this.MEAL_TYPE_CHOICES[1]">昼食</option>
                <option [value]="this.MEAL_TYPE_CHOICES[2]">夕食</option>
              </select>
              @if (errorMessages?.['meals']?.[i]; as errorMessages) {
                <ul>
                  @for (error of errorMessages?.['mealType'] | keyvalue; track error) {
                    <li>{{ error.value }}</li>
                  }
                </ul>
              }
            </div>

            <!-- メニュー(menu)のFormArrayを描画するセクション -->
            <div formArrayName="menu">
              <p class="form-label">メニューIDリスト:</p>

              <!-- 各メニューを @for でループして描画 -->
              @for (menu of getMenus(i).controls; track menu; let j = $index) {
                <div class="input-group mb-2">
                  <select [formControlName]="j" class="form-select">
                    <option [ngValue]="null" disabled>メニューを選択</option>
                    @for (menu of menus; track menu.id) {
                      <option [ngValue]="menu.id">{{ menu.name }}</option>
                    }
                  </select>
                  <button
                    type="button"
                    (click)="removeMenu(i, j)"
                    class="btn btn-outline-secondary"
                    type="button"
                  >
                    ×
                  </button>
                </div>
              }
              @if (errorMessages?.['meals']?.[i]?.['menu']; as errorMessages) {
                <ul>
                  @for (error of errorMessages | keyvalue; track error) {
                    <li>{{ error.value }}</li>
                  }
                </ul>
              }

              <button
                type="button"
                (click)="addMenu(i)"
                class="btn btn-sm btn-outline-primary mt-2"
              >
                ＋ メニューを追加
              </button>
            </div>
          </div>
        }
      </div>

      <button type="button" (click)="addMeal()" class="btn btn-secondary d-block w-100 mb-3">
        ＋ 食事を追加
      </button>

      <hr class="my-4" />

      <button type="submit" class="btn btn-primary btn-lg d-block w-100">
        登録[disabled]="!form.valid"
      </button>
    </form>
  </div>
</div>
